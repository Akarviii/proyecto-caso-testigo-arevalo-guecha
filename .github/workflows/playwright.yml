name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build_and_test:
    timeout-minutes: 15 # Increased timeout to accommodate all steps
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # --- Setup Python Environment and Backend ---
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' # Specify the Python version matching your project
    
    - name: Install Backend Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
        # Install pytest-cov for coverage later
        pip install pytest-cov

    # --- Run Backend Integration Tests ---
    - name: Run Backend Integration Tests
      run: |
        python -m pytest -v --cov=backend --cov-report=xml backend/tests/test_integration.py

    # --- Setup Node.js Environment and Frontend/Playwright ---
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: lts/* # Use LTS version of Node.js

    - name: Install Frontend/Playwright Dependencies
      run: |
        npm install # Installs root dependencies (Playwright, if any)
        npm install --prefix frontend # Installs frontend-specific dependencies
    
    - name: Install Playwright Browsers # Install Playwright's browsers for the CI environment
      run: npx playwright install --with-deps

    # --- Run Playwright E2E Tests ---
    - name: Run Playwright tests
      run: npx playwright test
      env:
        # Playwright's webServer will start the backend and frontend automatically
        # Ensure correct API_BASE_URL is used by frontend during E2E if hardcoded
        # (It's currently hardcoded to http://localhost:5000 in frontend/src/App.tsx)
        API_BASE_URL: http://localhost:5000 
    
    # --- Upload Playwright Test Report ---
    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always() # Uploads even if tests fail
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30